<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Python åˆ†å‘ç«™ â€” ä¸“ä¸šä¸‹è½½ï¼ˆå•æ–‡ä»¶ï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{
    /* åŸºç¡€è‰²ä¸è´¨æ„Ÿå˜é‡ï¼ˆé»˜è®¤ï¼šæµ…è‰²ç»ç’ƒ + æ©™è‰²ï¼‰ */
    --bg-light: linear-gradient(180deg,#eef5fb,#ffffff);
    --bg-dark: linear-gradient(180deg,#07101a,#0b1720);
    --panel-bg-light: rgba(255,255,255,0.56);
    --card-bg-light: rgba(255,255,255,0.66);
    --panel-bg-dark: rgba(8,12,18,0.40);
    --card-bg-dark: rgba(12,18,24,0.46);
    --muted-light: #5b6670;
    --muted-dark: #98a0a8;
    --accent: #f57c00;      /* å¯åˆ‡æ¢ */
    --accent-2: #ffb300;    /* å¯åˆ‡æ¢ */
    --radius:14px;
    --glass-blur:22px;
    --glass-sat:1.12;
    --glass-contrast:1.05;
    --gloss-opa:0.36;
    --shadow-1: 0 8px 28px rgba(6,12,24,0.08);
    --shadow-2: 0 20px 56px rgba(6,12,24,0.12);

    --ui: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    --mono: 'Roboto Mono', monospace;

    /* runtime variables (controlled by JS) */
    --page-bg: var(--bg-light);
    --panel-bg: var(--panel-bg-light);
    --card-bg: var(--card-bg-light);
    --muted: var(--muted-light);
    --text-color: #0b1220;
  }

  *{box-sizing:border-box}
  body{
    margin:0;font-family:var(--ui);background:var(--page-bg);color:var(--text-color);
    -webkit-font-smoothing:antialiased;transition:background .28s,color .28s;
  }
  .container{max-width:980px;margin:34px auto;padding:20px}

  /* Header glass: layered gloss + blur + soft shadow for "æ¶¦æ»‘"è´¨æ„Ÿ */
  header{
    position:relative; display:flex; align-items:center; gap:16px; padding:16px;
    border-radius:calc(var(--radius) + 4px);
    background:var(--panel-bg);
    border:1px solid rgba(255,255,255,0.08);
    box-shadow: var(--shadow-1);
    backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-sat)) contrast(var(--glass-contrast));
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-sat)) contrast(var(--glass-contrast));
    transition:transform .18s ease, box-shadow .18s, background .18s;
    overflow:visible;
  }
  header::before{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: linear-gradient(180deg, rgba(255,255,255,var(--gloss-opa)), rgba(255,255,255,0.02));
    mix-blend-mode: overlay; pointer-events:none;
  }

  .logo{
    width:58px; height:58px; border-radius:12px;
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1.4rem;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    box-shadow: 0 10px 30px rgba(0,0,0,0.12), 0 2px 0 rgba(255,255,255,0.09) inset;
    transform: translateZ(0);
  }
  .title h1{margin:0;font-size:18px}
  .title p{margin:6px 0 0;color:var(--muted);font-size:13px}
  .tools{margin-left:auto;display:flex;gap:10px;align-items:center;position:relative}

  /* Buttons: glass + subtle depth */
  .btn{
    display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.68));
    border:1px solid rgba(10,14,20,0.06);
    color:var(--text-color);font-weight:600;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease, opacity .12s;
    box-shadow: 0 3px 10px rgba(8,12,20,0.06), 0 1px 0 rgba(255,255,255,0.7) inset;
    backdrop-filter: blur(6px);
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{
    color:#fff;
    background-image:
      linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)),
      linear-gradient(180deg, var(--accent), var(--accent-2));
    border:1px solid rgba(0,0,0,0.06);
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
  }
  .btn.ghost{background:transparent;border:1px solid rgba(10,14,20,0.06)}

  /* theme menu: fixed layout, no overlap */
  .theme-menu{position:relative}
  .theme-toggle{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:transparent;border:1px solid rgba(12,18,30,0.04);cursor:pointer}
  .theme-panel{
    position:absolute; right:0; top:calc(100% + 12px); min-width:260px; padding:12px;border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.64), rgba(255,255,255,0.52));
    backdrop-filter: blur(18px) saturate(1.06);
    box-shadow: var(--shadow-2);
    border:1px solid rgba(255,255,255,0.06);
    display:none; flex-direction:column; gap:10px; z-index:3000;
    transform-origin: top right;
  }
  .theme-panel.show{display:flex; animation: pop .14s ease;}
  @keyframes pop { from{ transform: translateY(-6px) scale(.995); opacity:0 } to{ transform:none; opacity:1 } }
  .theme-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .theme-option{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
  .theme-option:hover{background:rgba(0,0,0,0.03)}
  .swatch{width:36px;height:28px;border-radius:6px;box-shadow: 0 6px 18px rgba(0,0,0,0.08)}
  .theme-label{font-weight:600;color:#222}

  .controls{display:flex;gap:10px;align-items:center;margin-top:18px}
  .search{flex:1;display:flex;gap:8px;align-items:center}
  input[type="search"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(10,14,20,0.06);background:rgba(255,255,255,0.8);font-size:14px}
  select{padding:9px;border-radius:10px;border:1px solid rgba(10,14,20,0.06);background:rgba(255,255,255,0.8);font-size:14px}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:18px}
  @media(max-width:820px){.grid{grid-template-columns:1fr}}
  .card{
    position:relative; background:var(--card-bg); border-radius:12px; padding:14px;
    border:1px solid rgba(255,255,255,0.06); box-shadow: 0 14px 40px rgba(8,12,24,0.06);
    display:flex; flex-direction:column; min-height:140px; transition: transform .16s ease, box-shadow .16s;
    backdrop-filter: blur(14px) saturate(1.04);
  }
  .card:hover{ transform: translateY(-6px); box-shadow: 0 26px 60px rgba(8,12,24,0.10) }
  .card::before{
    content:""; position:absolute; left:0; right:0; top:0; height:36%; border-radius:12px 12px 0 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.02)); mix-blend-mode: overlay;
    pointer-events:none;
  }

  .meta{display:flex;align-items:center;gap:12px}
  .tag{padding:6px 8px;border-radius:8px;font-weight:700;color:var(--accent);font-size:13px;background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02))}
  .name{font-weight:700;margin:0;font-size:15px}
  .desc{color:var(--muted);font-size:13px;margin:8px 0 0}
  .pill{font-family:var(--mono);background:rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;font-size:12px;color:#333}

  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,12,20,0.45);z-index:3500}
  .modal{width:92%;max-width:980px;border-radius:12px;padding:16px;background:rgba(255,255,255,0.95);color:var(--text-color);box-shadow:0 30px 60px rgba(2,6,23,0.45)}
  pre{background:rgba(246,248,251,0.6);padding:12px;border-radius:8px;overflow:auto;font-family:var(--mono);font-size:13px;max-height:62vh}
  .close{margin-left:auto;background:transparent;border:1px solid rgba(12,18,30,0.06);padding:8px;border-radius:8px;cursor:pointer}

  .copy-toast{position:fixed;right:22px;bottom:22px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.18);display:none}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

  .panel{position:fixed;right:20px;top:90px;width:360px;background:rgba(255,255,255,0.92);border-radius:12px;padding:12px;box-shadow:var(--shadow-2);z-index:3200;display:none}
  .panel.dark{background:rgba(8,12,18,0.88); color:#d9e6ef}
  .panel h3{margin:0 0 8px 0}
  .admin-list{max-height:240px;overflow:auto;border-top:1px dashed rgba(0,0,0,0.04);padding-top:8px;margin-top:8px}
  .muted-note{font-size:12px;color:var(--muted);margin-top:6px}

  /* auth UI */
  .auth-tabs{display:flex;gap:8px;margin-bottom:8px}
  .auth-tabs button{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(10,14,20,0.06);background:rgba(255,255,255,0.9);cursor:pointer}
  .form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
  .input-with-eye{position:relative}
  .eye-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;cursor:pointer;padding:6px}
  .user-bar{display:flex;align-items:center;gap:8px}
  .user-badge{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06);font-weight:600}

  /* small interactions */
  .theme-option:active, .admin-item:active{transform:translateY(1px)}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Py</div>
      <div class="title">
        <h1>Python åˆ†å‘ç«™ Â· ä¸“ä¸šä¸‹è½½</h1>
        <p>é€æ˜ç£¨ç ‚ã€æ¶¦æ»‘ç«‹ä½“ï¼›ç”¨æˆ·ç©ºé—´ä¸ç®¡ç†å‘˜åŠŸèƒ½ã€‚</p>
      </div>

      <div class="tools" role="toolbar" aria-label="site tools">
        <button class="btn primary" id="downloadAllBtn">ä¸‹è½½å…¨éƒ¨ (zip)</button>
        <button class="btn" id="refreshBtn">åˆ·æ–°</button>
        <button class="btn ghost" id="readmeBtn">è¯´æ˜</button>

        <div class="theme-menu" id="themeMenu">
          <button class="theme-toggle" id="themeToggle">ä¸»é¢˜ â–¾</button>
          <div class="theme-panel" id="themePanel" role="menu" aria-hidden="true">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">ä¸»é¢˜è®¾ç½®</div>
              <div class="small-note">é€æ˜ç£¨ç ‚ä¸è‰²å½©</div>
            </div>

            <div class="theme-row" aria-hidden="false">
              <div class="theme-option" data-theme="orange"><div class="swatch" style="background:linear-gradient(135deg,#f57c00,#ffb300)"></div><div class="theme-label">æ©™è‰²</div></div>
              <div class="theme-option" data-theme="blue"><div class="swatch" style="background:linear-gradient(135deg,#1976d2,#64b5f6)"></div><div class="theme-label">è“è‰²</div></div>
              <div class="theme-option" data-theme="green"><div class="swatch" style="background:linear-gradient(135deg,#2e7d32,#66bb6a)"></div><div class="theme-label">ç»¿è‰²</div></div>
              <div class="theme-option" data-theme="purple"><div class="swatch" style="background:linear-gradient(135deg,#8e24aa,#b39ddb)"></div><div class="theme-label">ç´«è‰²</div></div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
              <div style="display:flex;gap:8px;align-items:center">
                <label class="small-note">ç»ç’ƒæ ·å¼</label>
                <select id="glassStyle">
                  <option value="light">æµ…è‰²ç£¨ç ‚</option>
                  <option value="dark">æ·±è‰²ç£¨ç ‚</option>
                  <option value="colored">ç€è‰²ç£¨ç ‚</option>
                </select>
              </div>
              <div style="display:flex;gap:6px">
                <button class="btn" id="themeReset">é‡ç½®</button>
              </div>
            </div>

            <div class="small-note">æç¤ºï¼šç£¨ç ‚æ•ˆæœä½¿ç”¨ backdrop-filterï¼Œæ—§æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒã€‚å·²ä¿®å¤èœå•é‡å é—®é¢˜ä¸æ›´é¡ºæ»‘çš„ç»ç’ƒé«˜å…‰ã€‚</div>
          </div>
        </div>

        <div id="authSlot" style="display:flex;align-items:center;gap:8px"></div>

        <button class="btn ghost" id="adminBtn" title="ç®¡ç†å‘˜ç™»å½•">ç®¡ç†å‘˜</button>
      </div>
    </header>

    <div class="controls">
      <div class="search">
        <input type="search" id="search" placeholder="æœç´¢æ–‡ä»¶åã€æè¿°æˆ–å¹³å°ï¼ˆå›è½¦æœç´¢ï¼‰" />
      </div>
      <select id="filter">
        <option value="all">å…¨éƒ¨ç±»å‹</option>
        <option value="script">è„šæœ¬ (.py)</option>
        <option value="binary">äºŒè¿›åˆ¶/å®‰è£…åŒ…</option>
      </select>
      <select id="sort">
        <option value="name">æŒ‰åç§°</option>
        <option value="size">æŒ‰å¤§å°</option>
        <option value="downloads">æŒ‰ä¸‹è½½é‡</option>
      </select>
    </div>

    <main class="grid" id="grid" aria-live="polite"></main>

    <footer>éƒ¨ç½²åˆ°é™æ€ä¸»æœºæˆ– GitHub Pagesã€‚è¦è·¨è®¾å¤‡æ°¸ä¹…ä¿å­˜è¯·æ¥å…¥åç«¯æˆ– GitHub APIã€‚</footer>
  </div>

  <!-- preview modal -->
  <div class="modal-wrap" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modTitle">
      <div class="meta" style="display:flex;align-items:center;gap:12px">
        <div>
          <strong id="modTitle">é¢„è§ˆ</strong>
          <span id="modName" class="pill" style="margin-left:8px"></span>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" id="modDownload">ä¸‹è½½</button>
          <button class="btn" id="modCopy">å¤åˆ¶</button>
          <button class="close" id="modClose">å…³é—­</button>
        </div>
      </div>
      <pre id="modContent" tabindex="0"></pre>
    </div>
  </div>

  <div class="copy-toast" id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

  <!-- auth modal -->
  <div class="modal-wrap" id="authModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle" style="max-width:520px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <strong id="authTitle">ç”¨æˆ·ç™»å½•</strong>
        <div style="margin-left:auto"><button class="close" id="authClose">å…³é—­</button></div>
      </div>

      <div class="auth-tabs" role="tablist">
        <button id="tabLogin" data-tab="login">ç™»å½•</button>
        <button id="tabRegister" data-tab="register">æ³¨å†Œ</button>
        <button id="tabForgot" data-tab="forgot">å¿˜è®°å¯†ç </button>
      </div>

      <div id="authContent">
        <div class="auth-panel" id="panel-login">
          <div class="form-row"><label>ç”¨æˆ·åæˆ–é‚®ç®±<input id="login_user" type="text" placeholder="ç”¨æˆ·åæˆ–é‚®ç®±"></label></div>
          <div class="form-row input-with-eye">
            <label>å¯†ç 
              <input id="login_pass" type="password" placeholder="å¯†ç ">
              <button class="eye-btn" id="login_eye" title="æ˜¾ç¤º/éšè—å¯†ç ">ğŸ‘ï¸</button>
            </label>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn primary" id="doLogin">ç™»å½•</button>
            <button class="btn" id="openRegisterFromLogin">å»æ³¨å†Œ</button>
          </div>
          <div class="muted-note" style="margin-top:8px">é¦–æ¬¡ä½¿ç”¨è¯·æ³¨å†Œã€‚å¯†ç ç”¨ç›+SHA256ä¿å­˜äºæœ¬åœ°ã€‚</div>
        </div>

        <div class="auth-panel" id="panel-register" style="display:none">
          <div class="form-row"><label>ç”¨æˆ·å<input id="reg_user" type="text" placeholder="ç”¨æˆ·å"></label></div>
          <div class="form-row"><label>é‚®ç®±<input id="reg_email" type="text" placeholder="é‚®ç®±ï¼ˆå¯é€‰ï¼‰"></label></div>
          <div class="form-row input-with-eye">
            <label>å¯†ç 
              <input id="reg_pass" type="password" placeholder="è®¾ç½®å¯†ç  (â‰¥6)">
              <button class="eye-btn" id="reg_eye" title="æ˜¾ç¤º/éšè—å¯†ç ">ğŸ‘ï¸</button>
            </label>
          </div>
          <div class="form-row input-with-eye">
            <label>ç¡®è®¤å¯†ç 
              <input id="reg_pass2" type="password" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
              <button class="eye-btn" id="reg_eye2" title="æ˜¾ç¤º/éšè—å¯†ç ">ğŸ‘ï¸</button>
            </label>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn primary" id="doRegister">æ³¨å†Œ</button>
            <button class="btn" id="openLoginFromReg">å»ç™»å½•</button>
          </div>
        </div>

        <div class="auth-panel" id="panel-forgot" style="display:none">
          <div class="form-row"><label>ç”¨æˆ·åæˆ–é‚®ç®±<input id="forgot_user" type="text" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±"></label></div>
          <div style="display:flex;gap:8px">
            <button class="btn primary" id="doRequestReset">ç”Ÿæˆé‡ç½®ç </button>
            <button class="btn" id="openLoginFromForgot">å»ç™»å½•</button>
          </div>

          <div style="margin-top:12px">
            <div class="muted-note">æ­¤ç«™ä¸ºçº¯å®¢æˆ·ç«¯æ¼”ç¤ºï¼Œæ— æ³•å‘é€é‚®ä»¶ã€‚ç³»ç»Ÿä¼šç”Ÿæˆä¸€æ¬¡æ€§é‡ç½®ç ï¼ˆä»…åœ¨æœ¬æµè§ˆå™¨æ˜¾ç¤ºï¼‰ï¼Œç”¨è¯¥ç å¯ç›´æ¥é‡ç½®å¯†ç ã€‚</div>

            <div style="margin-top:8px" id="resetArea" hidden>
              <div class="form-row"><label>é‡ç½®ç <input id="reset_code" type="text" placeholder="ç²˜è´´é‡ç½®ç "></label></div>
              <div class="form-row input-with-eye"><label>æ–°å¯†ç <input id="reset_pass" type="password"><button class="eye-btn" id="reset_eye">ğŸ‘ï¸</button></label></div>
              <div style="display:flex;gap:8px"><button class="btn primary" id="doResetPassword">é‡ç½®å¯†ç </button></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- admin panel -->
  <div class="panel" id="adminPanel" aria-hidden="true">
    <h3>ç®¡ç†å‘˜é¢æ¿</h3>
    <div class="admin-row"><input type="text" id="a_name" placeholder="æ–‡ä»¶åï¼ˆå«æ‰©å±•åï¼‰" /></div>
    <div class="admin-row">
      <select id="a_type"><option value="script">script</option><option value="binary">binary</option></select>
      <input type="text" id="a_platform" placeholder="å¹³å°ï¼ˆå¦‚ Windows/Linuxï¼‰" />
    </div>
    <div class="admin-row"><input type="text" id="a_desc" placeholder="æè¿°" /></div>
    <div class="admin-row"><input type="file" id="a_file" /></div>
    <div class="admin-row"><textarea id="a_content" placeholder="æˆ–ç›´æ¥ç²˜è´´æºä»£ç  / å†…å®¹" rows="6"></textarea></div>
    <div style="display:flex;gap:8px">
      <button class="btn primary" id="a_save">ä¿å­˜å¹¶ä¸Šæ¶</button>
      <button class="btn" id="a_import">å¯¼å‡ºä¸Šä¼ (zip)</button>
      <button class="btn ghost" id="a_close">å…³é—­</button>
    </div>
    <div class="muted-note">è¯´æ˜ï¼šç®¡ç†å‘˜å¯†ç åœ¨å®¢æˆ·ç«¯æ ¡éªŒï¼ˆä¸å®‰å…¨ï¼‰ã€‚ä¸Šä¼ å†…å®¹ä¿å­˜åœ¨æœ¬æœº localStorageï¼Œä»…è¯¥æµè§ˆå™¨å¯è§ã€‚</div>
    <div class="admin-list" id="adminList"></div>
  </div>

  <!-- user personal panel -->
  <div class="panel" id="userPanel" aria-hidden="true">
    <h3>æˆ‘çš„ç©ºé—´</h3>
    <div class="admin-row"><input type="text" id="u_name" placeholder="æ–‡ä»¶åï¼ˆå«æ‰©å±•åï¼‰" /></div>
    <div class="admin-row">
      <select id="u_type"><option value="script">script</option><option value="binary">binary</option></select>
      <input type="text" id="u_platform" placeholder="å¹³å°ï¼ˆå¦‚ Windows/Linuxï¼‰" />
    </div>
    <div class="admin-row"><input type="text" id="u_desc" placeholder="æè¿°" /></div>
    <div class="admin-row"><input type="file" id="u_file" /></div>
    <div class="admin-row"><textarea id="u_content" placeholder="æˆ–ç›´æ¥ç²˜è´´æºä»£ç  / å†…å®¹" rows="6"></textarea></div>
    <div style="display:flex;gap:8px">
      <button class="btn primary" id="u_save">ä¿å­˜åˆ°æˆ‘çš„ç©ºé—´</button>
      <button class="btn" id="u_export">å¯¼å‡ºæˆ‘çš„æ–‡ä»¶(zip)</button>
      <button class="btn ghost" id="u_close">å…³é—­</button>
    </div>
    <div class="muted-note">ä½ åœ¨â€œæˆ‘çš„ç©ºé—´â€åˆ›å»ºçš„æ–‡ä»¶åªä¿å­˜åˆ°ä½ çš„æµè§ˆå™¨ï¼ˆlocalStorageï¼‰ï¼Œå¯å¯¼å‡ºå¤‡ä»½ã€‚å¦‚éœ€å…¬å¼€ä¿å­˜ï¼Œè¯·æ¥å…¥åç«¯æˆ– GitHub APIã€‚</div>
    <div class="admin-list" id="userList"></div>
  </div>

<script>
/* ---------------------- å­˜å‚¨ä¸é»˜è®¤æ•°æ® ---------------------- */
const DEFAULT_FILES = [
  { name: "ç»¿æ¢µAI.py", type: "script", platform: "Windows/Linux/macOS", desc: "ç¤ºä¾‹è„šæœ¬", content: "# è¿™é‡Œæ”¾å®Œæ•´è„šæœ¬" },
  { name: "éçˆ¬å–æ–¹å¼.py", type: "script", platform: "Cross-platform", desc: "ç¤ºä¾‹è„šæœ¬", content: "# è¿™é‡Œæ”¾å®Œæ•´è„šæœ¬" }
];

function loadUsers(){ try{ const r=localStorage.getItem('site_users'); return r? JSON.parse(r):[] }catch(e){return[]} }
function saveUsers(list){ try{ localStorage.setItem('site_users', JSON.stringify(list)); return true }catch(e){return false} }

function loadAllOwnedFiles(){ try{ const r=localStorage.getItem('files_by_owner'); return r? JSON.parse(r):[] }catch(e){return[]} }
function saveAllOwnedFiles(arr){ try{ localStorage.setItem('files_by_owner', JSON.stringify(arr)); return true }catch(e){return false} }

/* å…¼å®¹æ—§æ•°æ®ï¼ˆè¿ç§» user_filesï¼‰ */
(function migrateOldFiles(){
  try{
    const old = localStorage.getItem('user_files');
    if(!old) return;
    const arr = JSON.parse(old);
    if(!Array.isArray(arr)) return;
    const cur = loadAllOwnedFiles();
    arr.forEach(f=> { if(!f.owner) f.owner = 'admin'; cur.push(f); });
    saveAllOwnedFiles(cur);
    localStorage.removeItem('user_files');
  }catch(e){}
})();

let FILES = [];
function initFiles(){
  const owned = loadAllOwnedFiles();
  const map = {};
  DEFAULT_FILES.forEach(f => map[f.name] = Object.assign({owner:'builtin'}, f));
  owned.forEach(f => map[f.name] = Object.assign({}, f));
  FILES = Object.values(map);
}

/* ---------------------- crypto helpers ---------------------- */
async function randomBase64(lenBytes=12){ const a=new Uint8Array(lenBytes); crypto.getRandomValues(a); return btoa(String.fromCharCode(...a)); }
async function sha256Hex(str){ const buf=new TextEncoder().encode(str); const h=await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function saltedHashHex(saltBase64, password){ const saltBytes = atob(saltBase64); return sha256Hex(saltBytes + password); }

/* ---------------------- ç”¨æˆ·/ä¼šè¯é€»è¾‘ ---------------------- */
function findUserByNameOrEmail(key){ const users = loadUsers(); const k=String(key||'').toLowerCase(); return users.find(u=>u.username.toLowerCase()===k || (u.email||'').toLowerCase()===k); }
function setCurrentUser(username){ if(username) localStorage.setItem('current_user', username); else localStorage.removeItem('current_user'); renderAuthSlot(); }
function getCurrentUser(){ const name = localStorage.getItem('current_user'); if(!name) return null; const users = loadUsers(); return users.find(u=>u.username===name) || null; }

const DEFAULT_ADMIN_NAME='admin', DEFAULT_ADMIN_PASSWORD='lhm0627*';
async function ensureAdmin(){
  const users = loadUsers();
  if(!users.find(u=>u.username===DEFAULT_ADMIN_NAME)){
    const salt = await randomBase64(12);
    const h = await saltedHashHex(salt, DEFAULT_ADMIN_PASSWORD);
    users.push({username:DEFAULT_ADMIN_NAME,email:'',salt,passHash:h,role:'admin',createdAt:new Date().toISOString()});
    saveUsers(users);
  }
}

async function registerUser(username, email, password){
  username = String(username||'').trim();
  if(!username) throw new Error('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
  if((password||'').length < 6) throw new Error('å¯†ç è‡³å°‘6ä½');
  const users = loadUsers();
  if(users.find(u=>u.username.toLowerCase() === username.toLowerCase())) throw new Error('ç”¨æˆ·åå·²å­˜åœ¨');
  if(email && users.find(u=> (u.email||'').toLowerCase() === (email||'').toLowerCase())) throw new Error('é‚®ç®±å·²è¢«ä½¿ç”¨');
  const salt = await randomBase64(12);
  const ph = await saltedHashHex(salt, password);
  const user = { username, email: email||'', salt, passHash: ph, role: 'user', createdAt: new Date().toISOString() };
  users.push(user);
  saveUsers(users);
  setCurrentUser(username);
  return user;
}

async function loginUser(key, password){
  const u = findUserByNameOrEmail(key);
  if(!u) throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
  const ph = await saltedHashHex(u.salt, password);
  if(ph !== u.passHash) throw new Error('å¯†ç é”™è¯¯');
  setCurrentUser(u.username);
  return u;
}

function logoutUser(){ setCurrentUser(null); }

function generateResetCodeFor(userKey){
  const u = findUserByNameOrEmail(userKey);
  if(!u) return {ok:false, msg:'ç”¨æˆ·ä¸å­˜åœ¨'};
  const code = Math.random().toString(36).slice(2,10).toUpperCase();
  const exp = Date.now() + 1000*60*20;
  const store = JSON.parse(localStorage.getItem('pw_reset')||'{}');
  store[u.username] = { code, exp };
  localStorage.setItem('pw_reset', JSON.stringify(store));
  return { ok:true, username: u.username, code, expiresAt: exp };
}
function verifyResetCode(username, code){
  const store = JSON.parse(localStorage.getItem('pw_reset')||'{}');
  const rec = store[username];
  if(!rec) return false;
  if(Date.now() > rec.exp) { delete store[username]; localStorage.setItem('pw_reset', JSON.stringify(store)); return false; }
  if(rec.code !== code) return false;
  delete store[username]; localStorage.setItem('pw_reset', JSON.stringify(store));
  return true;
}
async function resetPassword(username, newPassword){
  const users = loadUsers(); const idx = users.findIndex(u=>u.username===username);
  if(idx<0) throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
  const salt = await randomBase64(12); const ph = await saltedHashHex(salt, newPassword);
  users[idx].salt = salt; users[idx].passHash = ph; saveUsers(users); return true;
}

/* ---------------------- æ¯ç”¨æˆ·æ–‡ä»¶ï¼ˆæˆ‘çš„ç©ºé—´ï¼‰ ---------------------- */
function loadOwnedFilesBy(owner){ const all = loadAllOwnedFiles(); return all.filter(f => f.owner === owner); }
function saveOwnedFileFor(owner, fileObj){ const all = loadAllOwnedFiles(); const idx = all.findIndex(x => x.owner===owner && x.name === fileObj.name); const item = Object.assign({owner}, fileObj); if(idx>=0) all[idx] = item; else all.push(item); saveAllOwnedFiles(all); }
function deleteOwnedFile(owner, name){ let all = loadAllOwnedFiles(); all = all.filter(x => !(x.owner===owner && x.name === name)); saveAllOwnedFiles(all); }

/* ---------------------- UI æ¸²æŸ“ï¼šauthSlot ä¸è´¦æˆ·èœå•ï¼ˆå«åˆ‡æ¢è´¦æˆ·ï¼‰ ---------------------- */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

function renderAuthSlot(){
  const slot = document.getElementById('authSlot'); slot.innerHTML = '';
  const cur = getCurrentUser();
  if(cur){
    const wrapper = document.createElement('div'); wrapper.className='user-bar';
    const badge = document.createElement('div'); badge.className='user-badge'; badge.textContent = cur.username;
    wrapper.appendChild(badge);

    const menuBtn = document.createElement('button'); menuBtn.className='btn ghost'; menuBtn.textContent='è´¦æˆ· â–¾';
    const menu = document.createElement('div');
    menu.style.position='absolute'; menu.style.right='18px'; menu.style.top='68px'; menu.style.zIndex='3400'; menu.style.display='none';
    menu.style.background='rgba(255,255,255,0.96)'; menu.style.border='1px solid rgba(0,0,0,0.06)'; menu.style.padding='8px'; menu.style.borderRadius='8px'; menu.style.boxShadow='0 12px 40px rgba(0,0,0,0.08)';
    menu.style.minWidth = '180px';

    const items = [
      {label:'æˆ‘çš„ç©ºé—´', action: ()=>{ openUserPanel(); menu.style.display='none'; }},
      {label:'åˆ‡æ¢è´¦æˆ·', action: ()=>{ showAccountSwitch(menu); }},
      {label:'æ³¨é”€', action: ()=>{ logoutUser(); menu.style.display='none'; alert('å·²æ³¨é”€'); }},
      {label:'åˆ é™¤è´¦æˆ·', action: ()=>{ if(confirm('ç¡®è®¤åˆ é™¤å½“å‰è´¦æˆ·ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ˆä»…æœ¬åœ°ï¼‰')){ const name = cur.username; let us=loadUsers(); us=us.filter(u=>u.username!==name); saveUsers(us); setCurrentUser(null); menu.style.display='none'; alert('å·²åˆ é™¤'); } }},
      {label:'ç®¡ç†å‘˜é¢æ¿', action: ()=>{ menu.style.display='none'; openAdminPanel(); }}
    ];
    items.forEach(it=>{
      const d = document.createElement('div'); d.textContent = it.label; d.style.padding='8px'; d.style.cursor='pointer';
      d.addEventListener('click', it.action); d.addEventListener('mouseover', ()=> d.style.background='rgba(0,0,0,0.03)'); d.addEventListener('mouseout', ()=> d.style.background='transparent');
      menu.appendChild(d);
    });

    menuBtn.addEventListener('click', ()=> menu.style.display = menu.style.display==='none' ? 'block' : 'none');
    wrapper.appendChild(menuBtn); wrapper.appendChild(menu);
    slot.appendChild(wrapper);
  }else{
    const btn = document.createElement('button'); btn.className='btn ghost'; btn.id='showAuthBtn'; btn.textContent='ç™»å½• / æ³¨å†Œ';
    btn.addEventListener('click', ()=> { openAuthModal('login'); prefillAdminLogin(false); });
    slot.appendChild(btn);
  }
}

/* åˆ‡æ¢è´¦æˆ·ï¼šåˆ—å‡ºæœ¬åœ°ç”¨æˆ·ï¼Œç‚¹å‡»åæç¤ºå¯†ç å¹¶åˆ‡æ¢ï¼ˆæé«˜ä¾¿æ·æ€§ï¼‰ */
function showAccountSwitch(parentMenu){
  parentMenu.innerHTML = '';
  const users = loadUsers();
  const cur = getCurrentUser();
  const title = document.createElement('div'); title.textContent='é€‰æ‹©è¦åˆ‡æ¢çš„è´¦æˆ·'; title.style.fontWeight='700'; title.style.padding='6px 8px';
  parentMenu.appendChild(title);
  users.forEach(u=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 8px';
    row.style.cursor='pointer';
    row.textContent = u.username + (u.role==='admin' ? ' (ç®¡ç†å‘˜)':'');
    row.addEventListener('click', async ()=>{
      if(confirm(`åˆ‡æ¢åˆ° ${u.username} ?`)){
        const pwd = prompt(`è¯·è¾“å…¥ ${u.username} çš„å¯†ç ä»¥åˆ‡æ¢è´¦æˆ·ï¼š`);
        if(pwd === null) return;
        const ph = await saltedHashHex(u.salt, pwd);
        if(ph === u.passHash){ setCurrentUser(u.username); parentMenu.style.display='none'; alert(`å·²åˆ‡æ¢åˆ° ${u.username}`); } else alert('å¯†ç é”™è¯¯ï¼Œæ— æ³•åˆ‡æ¢');
      }
    });
    parentMenu.appendChild(row);
  });
  const back = document.createElement('div'); back.textContent='â† è¿”å›'; back.style.padding='8px'; back.style.cursor='pointer'; back.style.color='#666';
  back.addEventListener('click', ()=> parentMenu.style.display='none');
  parentMenu.appendChild(back);
}

/* ---------------------- æ–‡ä»¶åˆ—è¡¨æ¸²æŸ“ä¸äº¤äº’ ---------------------- */
async function sha1Hex(str){ const buf=new TextEncoder().encode(str||''); const hash=await crypto.subtle.digest('SHA-1', buf); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

function makeCard(f, idx){
  const div = document.createElement('article'); div.className='card';
  div.innerHTML = `
    <div class="meta">
      <div class="tag">${escapeHtml((f.type||'file').toUpperCase())}</div>
      <div style="flex:1">
        <p class="name">${escapeHtml(f.name)}</p>
        <div class="desc">${escapeHtml(f.desc||'')}</div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <span class="pill">${escapeHtml(f.platform||'Unknown')}</span>
          <span class="small" id="size-${idx}">è®¡ç®—å¤§å°â€¦</span>
          <span class="count" id="count-${idx}"></span>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" data-download="${idx}">ä¸‹è½½</button>
        <button class="btn" data-view="${idx}">é¢„è§ˆ</button>
      </div>
    </div>
  `;
  const sizeEl = div.querySelector(`#size-${idx}`); const countEl = div.querySelector(`#count-${idx}`);
  const blob = new Blob([f.content || ''], {type:'application/octet-stream'});
  sizeEl.textContent = blob.size < 1024 ? `${blob.size} B` : `${(blob.size/1024).toFixed(1)} KB`;
  const counts = JSON.parse(localStorage.getItem('dl_counts')||'{}'); countEl.textContent = `ä¸‹è½½ ${counts[f.name]||0} æ¬¡`;
  div.querySelector('[data-download]').onclick = ()=> downloadFile(idx);
  div.querySelector('[data-view]').onclick = ()=> openModal(idx);
  return div;
}
function render(list){ const grid = document.getElementById('grid'); grid.innerHTML=''; list.forEach((f,i)=> grid.appendChild(makeCard(f,i))); }
function applyFilters(){ const q=document.getElementById('search').value.trim().toLowerCase(); const filter=document.getElementById('filter').value; const sort=document.getElementById('sort').value; let list = FILES.filter(f=>{ if(filter!=='all' && f.type!==filter) return false; if(!q) return true; return (f.name + (f.desc||'') + (f.platform||'')).toLowerCase().includes(q); }); if(sort==='name') list.sort((a,b)=>a.name.localeCompare(b.name)); else if(sort==='size') list.sort((a,b)=> (new Blob([a.content||'']).size) - (new Blob([b.content||'']).size) ); else if(sort==='downloads'){ const counts = JSON.parse(localStorage.getItem('dl_counts')||'{}'); list.sort((a,b)=>(counts[b.name]||0)-(counts[a.name]||0)); } render(list); }

/* ---------------------- ä¸‹è½½/é¢„è§ˆ ---------------------- */
async function downloadFile(i){
  const f = FILES[i];
  const counts = JSON.parse(localStorage.getItem('dl_counts')||'{}'); counts[f.name] = (counts[f.name]||0)+1; localStorage.setItem('dl_counts', JSON.stringify(counts));
  applyFilters();
  if(f.url){ const a=document.createElement('a'); a.href=f.url; a.download=f.name; document.body.appendChild(a); a.click(); a.remove(); return; }
  if(typeof f.content === 'string' && f.content.startsWith('__base64__:')){ const b64=f.content.slice('__base64__:'.length); const byteChars=atob(b64); const byteNumbers=new Array(byteChars.length); for(let j=0;j<byteChars.length;j++) byteNumbers[j]=byteChars.charCodeAt(j); const byteArray=new Uint8Array(byteNumbers); const blob=new Blob([byteArray], {type:'application/octet-stream'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=f.name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),5000); return; }
  const blob = new Blob([f.content || ''], {type: f.type==='script' ? 'text/x-python;charset=utf-8' : 'application/octet-stream'});
  sha1Hex(f.content || '').then(h=> console.log(`${f.name} SHA1: ${h}`)).catch(()=>{});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=f.name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),5000);
}
function openModal(i){ const f = FILES[i]; document.getElementById('modName').textContent = f.name; document.getElementById('modTitle').textContent = `${(f.type||'file').toUpperCase()} é¢„è§ˆ`; document.getElementById('modContent').textContent = f.content || '(æ— å†…å®¹)'; document.getElementById('modal').style.display='flex'; document.getElementById('modDownload').onclick = ()=> downloadFile(i); document.getElementById('modCopy').onclick = ()=> navigator.clipboard.writeText(f.content || '').then(()=> showToast()); }
document.getElementById('modClose').onclick = ()=> document.getElementById('modal').style.display='none';
function downloadAll(){ const zip = new JSZip(); FILES.forEach(f=> zip.file(f.name, f.content || '')); zip.generateAsync({type:'blob', compression:'DEFLATE'}).then(blob=>{ const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='python-files.zip'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),5000); }); }
function showToast(){ const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',1400); }

/* ---------------------- ç®¡ç†é¢æ¿é€»è¾‘ ---------------------- */
function openAdminPanel(){
  const cur = getCurrentUser();
  if(!cur || cur.role !== 'admin'){ alert('éœ€è¦ç®¡ç†å‘˜æƒé™ï¼šè¯·ç”¨ admin è´¦æˆ·ç™»å½•'); openAuthModal('login'); prefillAdminLogin(true); return; }
  const panel = document.getElementById('adminPanel'); panel.style.display='block'; panel.classList.toggle('dark', getCurrentGlassStyle() === 'dark'); refreshAdminList();
}
document.getElementById('a_close').addEventListener('click', ()=>{ document.getElementById('adminPanel').style.display='none'; });

document.getElementById('a_file').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const isText = f.type.startsWith('text') || /\.(py|txt|md|json|js|html|css)$/i.test(f.name);
  if(isText){ const txt = await f.text(); document.getElementById('a_content').value = txt; document.getElementById('a_name').value = f.name; } else {
    const reader = new FileReader(); reader.onload = ()=> { document.getElementById('a_content').value = `__base64__:${reader.result.split(',')[1]}`; document.getElementById('a_name').value = f.name; document.getElementById('a_type').value = 'binary'; }; reader.readAsDataURL(f);
  }
});

document.getElementById('a_save').addEventListener('click', ()=>{
  const name = document.getElementById('a_name').value.trim(); const type = document.getElementById('a_type').value; const platform = document.getElementById('a_platform').value.trim() || 'Unknown'; const desc = document.getElementById('a_desc').value.trim() || ''; const content = document.getElementById('a_content').value || '';
  if(!name){ alert('è¯·å¡«å†™æ–‡ä»¶å'); return; }
  const all = loadAllOwnedFiles(); const idx = all.findIndex(u=>u.name === name && u.owner === 'admin'); const item = { owner:'admin', name, type, platform, desc, content }; if(idx>=0) all[idx] = item; else all.push(item);
  if(saveAllOwnedFiles(all)){ alert('å·²ä¿å­˜å¹¶ä¸Šæ¶ï¼ˆæœ¬åœ°ï¼‰'); initFiles(); applyFilters(); refreshAdminList(); document.getElementById('a_name').value=''; document.getElementById('a_desc').value=''; document.getElementById('a_content').value=''; document.getElementById('a_file').value=''; } else alert('ä¿å­˜å¤±è´¥');
});

document.getElementById('a_import').addEventListener('click', async ()=>{
  const all = loadAllOwnedFiles(); if(!all.length){ alert('æ— ä¸Šä¼ æ–‡ä»¶'); return; }
  const zip = new JSZip(); all.forEach(u=>{ if(typeof u.content === 'string' && u.content.startsWith('__base64__:')){ const b64 = u.content.slice('__base64__:'.length); const byteChars = atob(b64); const byteNumbers = new Array(byteChars.length); for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i); const byteArray = new Uint8Array(byteNumbers); zip.file(u.name, byteArray); } else zip.file(u.name, u.content || ''); });
  const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='user-uploads.zip'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),5000);
});

function refreshAdminList(){
  const list = document.getElementById('adminList'); const all = loadAllOwnedFiles(); list.innerHTML = '';
  if(!all.length){ list.innerHTML = '<div class="muted-note">æš‚æ— æ–‡ä»¶</div>'; return; }
  all.forEach((u,i)=>{ const div=document.createElement('div'); div.className='admin-item'; div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(u.name)}</strong><div style="font-size:12px;color:var(--muted)">owner: ${escapeHtml(u.owner)}</div></div><div style="display:flex;gap:6px"><button class="btn" data-load="${i}">åŠ è½½</button><button class="btn" data-del="${i}">åˆ é™¤</button></div>`; list.appendChild(div);
    div.querySelector('[data-load]').onclick = ()=> { document.getElementById('a_name').value=u.name; document.getElementById('a_type').value=u.type; document.getElementById('a_platform').value=u.platform; document.getElementById('a_desc').value=u.desc; document.getElementById('a_content').value=u.content||''; };
    div.querySelector('[data-del]').onclick = ()=> { if(!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return; const arr = loadAllOwnedFiles(); arr.splice(i,1); saveAllOwnedFiles(arr); initFiles(); applyFilters(); refreshAdminList(); };
  });
}

/* ---------------------- user panelï¼ˆæˆ‘çš„ç©ºé—´ï¼‰ ---------------------- */
document.getElementById('u_close').addEventListener('click', ()=> { document.getElementById('userPanel').style.display='none'; });

document.getElementById('u_file').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const isText = f.type.startsWith('text') || /\.(py|txt|md|json|js|html|css)$/i.test(f.name);
  if(isText){ const txt = await f.text(); document.getElementById('u_content').value = txt; document.getElementById('u_name').value = f.name; } else {
    const reader = new FileReader(); reader.onload = ()=> { document.getElementById('u_content').value = `__base64__:${reader.result.split(',')[1]}`; document.getElementById('u_name').value = f.name; document.getElementById('u_type').value = 'binary'; }; reader.readAsDataURL(f);
  }
});

document.getElementById('u_save').addEventListener('click', ()=>{
  const cur = getCurrentUser();
  if(!cur){ alert('è¯·å…ˆç™»å½•'); return; }
  const owner = cur.username; const name = document.getElementById('u_name').value.trim(); const type = document.getElementById('u_type').value; const platform = document.getElementById('u_platform').value.trim() || 'Unknown'; const desc = document.getElementById('u_desc').value.trim() || ''; const content = document.getElementById('u_content').value || '';
  if(!name){ alert('è¯·å¡«å†™æ–‡ä»¶å'); return; }
  saveOwnedFileFor(owner, { name, type, platform, desc, content });
  alert('å·²ä¿å­˜åˆ°ä½ çš„ä¸ªäººç©ºé—´ï¼ˆæœ¬åœ°ï¼‰');
  initFiles(); applyFilters(); refreshUserList();
  document.getElementById('u_name').value=''; document.getElementById('u_desc').value=''; document.getElementById('u_content').value=''; document.getElementById('u_file').value='';
});

document.getElementById('u_export').addEventListener('click', async ()=>{
  const cur = getCurrentUser();
  if(!cur){ alert('è¯·å…ˆç™»å½•'); return; }
  const files = loadOwnedFilesBy(cur.username); if(!files.length){ alert('æš‚æ— ä¸ªäººæ–‡ä»¶'); return; }
  const zip = new JSZip(); files.forEach(u=>{ if(typeof u.content === 'string' && u.content.startsWith('__base64__:')){ const b64 = u.content.slice('__base64__:'.length); const byteChars = atob(b64); const byteNumbers = new Array(byteChars.length); for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i); const byteArray = new Uint8Array(byteNumbers); zip.file(u.name, byteArray); } else zip.file(u.name, u.content || ''); });
  const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${cur.username}-files.zip`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),5000);
});

function openUserPanel(){
  const cur = getCurrentUser();
  if(!cur){ alert('è¯·å…ˆç™»å½•'); openAuthModal('login'); return; }
  document.getElementById('userPanel').style.display='block';
  refreshUserList();
}

function refreshUserList(){
  const cur = getCurrentUser(); const list = document.getElementById('userList'); list.innerHTML=''; if(!cur){ list.innerHTML = '<div class="muted-note">è¯·å…ˆç™»å½•æŸ¥çœ‹ä¸ªäººç©ºé—´</div>'; return; }
  const files = loadOwnedFilesBy(cur.username); if(!files.length){ list.innerHTML = '<div class="muted-note">ä½ çš„ç©ºé—´è¿˜æ²¡æœ‰æ–‡ä»¶</div>'; return; }
  files.forEach((u,i)=>{ const div=document.createElement('div'); div.className='admin-item'; div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(u.name)}</strong><div style="font-size:12px;color:var(--muted)">${escapeHtml(u.desc||'')}</div></div><div style="display:flex;gap:6px"><button class="btn" data-load="${i}">åŠ è½½</button><button class="btn" data-del="${i}">åˆ é™¤</button></div>`; list.appendChild(div);
    div.querySelector('[data-load]').onclick = ()=> { document.getElementById('u_name').value=u.name; document.getElementById('u_type').value=u.type; document.getElementById('u_platform').value=u.platform; document.getElementById('u_desc').value=u.desc; document.getElementById('u_content').value=u.content||''; };
    div.querySelector('[data-del]').onclick = ()=> { if(!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return; deleteOwnedFile(cur.username, u.name); initFiles(); applyFilters(); refreshUserList(); };
  });
}

/* ---------------------- auth modalé€»è¾‘ + æ˜¾ç¤ºå¯†ç çœ¼ç›æŒ‰é’® ---------------------- */
function openAuthModal(tab='login'){ closeAllFloating(); document.getElementById('authModal').style.display='flex'; showAuthTab(tab); }
function closeAuthModal(){ document.getElementById('authModal').style.display='none'; }
document.getElementById('authClose').addEventListener('click', closeAuthModal);
document.getElementById('tabLogin').addEventListener('click', ()=> showAuthTab('login'));
document.getElementById('tabRegister').addEventListener('click', ()=> showAuthTab('register'));
document.getElementById('tabForgot').addEventListener('click', ()=> showAuthTab('forgot'));

function showAuthTab(name){ ['login','register','forgot'].forEach(n=> { const panel = document.getElementById('panel-'+n); if(panel) panel.style.display = (n===name)?'block':'none'; }); document.getElementById('authTitle').textContent = name==='login' ? 'ç”¨æˆ·ç™»å½•' : name==='register' ? 'ç”¨æˆ·æ³¨å†Œ' : 'å¿˜è®°å¯†ç '; }

function toggleInputVisible(btnId, inputId){
  const btn = document.getElementById(btnId), inp = document.getElementById(inputId);
  if(!btn||!inp) return; btn.addEventListener('click', ()=> inp.type = inp.type === 'password' ? 'text' : 'password');
}
toggleInputVisible('login_eye','login_pass'); toggleInputVisible('reg_eye','reg_pass'); toggleInputVisible('reg_eye2','reg_pass2'); toggleInputVisible('reset_eye','reset_pass');

document.getElementById('openRegisterFromLogin').addEventListener('click', ()=> showAuthTab('register'));
document.getElementById('openLoginFromReg').addEventListener('click', ()=> showAuthTab('login'));
document.getElementById('openLoginFromForgot').addEventListener('click', ()=> showAuthTab('login'));

document.getElementById('doRegister').addEventListener('click', async ()=>{
  try{
    const u = document.getElementById('reg_user').value.trim(); const e = document.getElementById('reg_email').value.trim(); const p = document.getElementById('reg_pass').value; const p2 = document.getElementById('reg_pass2').value;
    if(p !== p2) { alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'); return; }
    await registerUser(u, e, p);
    alert('æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½•');
    closeAuthModal(); renderAuthSlot(); initFiles(); applyFilters();
  }catch(err){ alert('æ³¨å†Œå¤±è´¥ï¼š' + err.message) }
});

document.getElementById('doLogin').addEventListener('click', async ()=>{
  try{
    const key = document.getElementById('login_user').value.trim(); const p = document.getElementById('login_pass').value;
    await loginUser(key, p);
    alert('ç™»å½•æˆåŠŸ'); closeAuthModal(); renderAuthSlot();
  }catch(err){ alert('ç™»å½•å¤±è´¥ï¼š' + err.message) }
});

document.getElementById('doRequestReset').addEventListener('click', ()=>{
  const key = document.getElementById('forgot_user').value.trim();
  if(!key){ alert('è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±'); return; }
  const res = generateResetCodeFor(key);
  if(!res.ok){ alert('æ‰¾ä¸åˆ°ç”¨æˆ·'); return; }
  const area = document.getElementById('resetArea'); area.hidden = false;
  alert(`é‡ç½®ç ï¼ˆä»…åœ¨æœ¬æµè§ˆå™¨æ˜¾ç¤ºï¼‰ï¼š${res.code}\nè¯·å¤åˆ¶ç²˜è´´åˆ°ä¸‹æ–¹ä»¥ç»§ç»­é‡ç½®ã€‚æœ‰æ•ˆæœŸ20åˆ†é’Ÿã€‚`);
  document.getElementById('reset_code').value = res.code;
});
document.getElementById('doResetPassword').addEventListener('click', async ()=>{
  try{
    const code = document.getElementById('reset_code').value.trim(); const pass = document.getElementById('reset_pass').value;
    if(!code || !pass){ alert('è¯·è¾“å…¥é‡ç½®ç å’Œæ–°å¯†ç '); return; }
    const store = JSON.parse(localStorage.getItem('pw_reset')||'{}'); let foundUser = null;
    for(const uname in store){ if(store[uname].code === code) { foundUser = uname; break; } }
    if(!foundUser){ alert('é‡ç½®ç æ— æ•ˆæˆ–å·²è¿‡æœŸ'); return; }
    const ok = verifyResetCode(foundUser, code);
    if(!ok){ alert('é‡ç½®ç æ— æ•ˆæˆ–å·²è¿‡æœŸ'); return; }
    await resetPassword(foundUser, pass);
    alert('å¯†ç å·²é‡ç½®ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•'); showAuthTab('login');
  }catch(err){ alert('é‡ç½®å¤±è´¥ï¼š' + err.message) }
});

/* ä¾¿æ·ï¼šadmin æŒ‰é’®è¡Œä¸ºæ”¹è¿›ï¼ˆè‹¥å·²ç™»å½•ä¸º admin ç›´æ¥æ‰“å¼€é¢æ¿ï¼›å¦åˆ™æ‰“å¼€ç™»å½•å¹¶é¢„å¡« adminï¼‰ */
document.getElementById('adminBtn').addEventListener('click', ()=> {
  const cur = getCurrentUser();
  if(cur && cur.role === 'admin') openAdminPanel();
  else { openAuthModal('login'); prefillAdminLogin(true); }
});

/* ä¾¿æ·ï¼šå¦‚æœç®¡ç†å‘˜æ— æ³•ä½¿ç”¨ï¼Œé¢„å¡« admin ç”¨æˆ·åå¹¶èšç„¦å¯†ç  */
function prefillAdminLogin(focusPassword){
  const loginInput = document.getElementById('login_user');
  if(loginInput) loginInput.value = 'admin';
  if(focusPassword){
    setTimeout(()=> { const p = document.getElementById('login_pass'); if(p) { p.focus(); } }, 160);
  }
}

/* ---------------------- ä¸»é¢˜ä¸ç»ç’ƒæ ·å¼æ§åˆ¶ï¼ˆå¢å¼ºï¼‰ ---------------------- */
const THEMES = {
  orange: {accent:'#f57c00', accent2:'#ffb300'},
  blue:   {accent:'#1976d2', accent2:'#64b5f6'},
  green:  {accent:'#2e7d32', accent2:'#66bb6a'},
  purple: {accent:'#8e24aa', accent2:'#b39ddb'}
};

function applyTheme(name){
  const t = THEMES[name]; if(!t) return;
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--accent-2', t.accent2);
  document.querySelectorAll('.logo').forEach(el=> el.style.background = `linear-gradient(135deg, ${t.accent}, ${t.accent2})`);
  localStorage.setItem('site_theme', name);
  // if colored glass is selected, tint the panel/card slightly
  if(getCurrentGlassStyle() === 'colored'){
    document.documentElement.style.setProperty('--panel-bg', hexToRgba(t.accent, 0.14));
    document.documentElement.style.setProperty('--card-bg', hexToRgba(t.accent, 0.10));
  }
}

function hexToRgba(hex, alpha){
  try{
    const h = hex.replace('#','');
    const r = parseInt(h.substr(0,2),16), g = parseInt(h.substr(2,2),16), b = parseInt(h.substr(4,2),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }catch(e){ return `rgba(255,255,255,${alpha})`; }
}

function applyGlassStyle(style){
  localStorage.setItem('glass_style', style);
  if(style === 'light'){
    document.documentElement.style.setProperty('--page-bg', getComputedStyle(document.documentElement).getPropertyValue('--bg-light'));
    document.documentElement.style.setProperty('--panel-bg', getComputedStyle(document.documentElement).getPropertyValue('--panel-bg-light'));
    document.documentElement.style.setProperty('--card-bg', getComputedStyle(document.documentElement).getPropertyValue('--card-bg-light'));
    document.documentElement.style.setProperty('--muted', getComputedStyle(document.documentElement).getPropertyValue('--muted-light'));
    document.documentElement.style.setProperty('--text-color', '#0b1220');
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('dark'));
  }else if(style === 'dark'){
    document.documentElement.style.setProperty('--page-bg', getComputedStyle(document.documentElement).getPropertyValue('--bg-dark'));
    document.documentElement.style.setProperty('--panel-bg', getComputedStyle(document.documentElement).getPropertyValue('--panel-bg-dark'));
    document.documentElement.style.setProperty('--card-bg', getComputedStyle(document.documentElement).getPropertyValue('--card-bg-dark'));
    document.documentElement.style.setProperty('--muted', getComputedStyle(document.documentElement).getPropertyValue('--muted-dark'));
    document.documentElement.style.setProperty('--text-color', '#d9e6ef');
    document.querySelectorAll('.panel').forEach(p=>p.classList.add('dark'));
  }else if(style === 'colored'){
    // keep page bg light but tint panels/cards with accent
    const name = localStorage.getItem('site_theme') || 'orange';
    const t = THEMES[name];
    document.documentElement.style.setProperty('--page-bg', getComputedStyle(document.documentElement).getPropertyValue('--bg-light'));
    document.documentElement.style.setProperty('--panel-bg', hexToRgba(t.accent, 0.12));
    document.documentElement.style.setProperty('--card-bg', hexToRgba(t.accent, 0.08));
    document.documentElement.style.setProperty('--muted', getComputedStyle(document.documentElement).getPropertyValue('--muted-light'));
    document.documentElement.style.setProperty('--text-color', '#0b1220');
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('dark'));
  }
}

function getCurrentGlassStyle(){ return localStorage.getItem('glass_style') || 'light'; }

document.querySelectorAll('.theme-option').forEach(el=> { el.addEventListener('click', ()=> { applyTheme(el.getAttribute('data-theme')); }); });
document.getElementById('glassStyle').addEventListener('change', (e)=> { applyGlassStyle(e.target.value); });
document.getElementById('themeToggle').addEventListener('click', ()=> {
  const p = document.getElementById('themePanel'); closeAllFloating(); p.classList.toggle('show'); p.setAttribute('aria-hidden', p.classList.contains('show') ? 'false' : 'true');
});
document.getElementById('themeReset').addEventListener('click', ()=> { localStorage.removeItem('site_theme'); localStorage.removeItem('glass_style'); restoreTheme(); });

function restoreTheme(){
  const name = localStorage.getItem('site_theme') || 'orange';
  const style = localStorage.getItem('glass_style') || 'light';
  applyTheme(name);
  applyGlassStyle(style);
  // set controls
  const sel = document.getElementById('glassStyle'); if(sel) sel.value = style;
}

/* ---------------------- ä¾¿æ·ï¼šå…³é—­æ‰€æœ‰æµ®åŠ¨é¢æ¿ ---------------------- */
function closeAllFloating(){ document.querySelectorAll('.theme-panel').forEach(e=> e.classList.remove('show')); document.querySelectorAll('.panel').forEach(p=> p.style.display='none'); document.getElementById('authModal').style.display='none'; document.getElementById('modal').style.display='none'; }

/* ---------------------- ä¾¿æ·ï¼šå½“ç®¡ç†å‘˜æ— æ³•ä½¿ç”¨æ—¶æ”¶é›†è¯Šæ–­ï¼ˆæ§åˆ¶å°è¾“å‡ºï¼‰ ---------------------- */
function adminDiagnostics(){
  const users = loadUsers(); const cur = getCurrentUser();
  console.debug('--- admin diagnostics ---');
  console.debug('users:', users);
  console.debug('current user:', cur);
  console.debug('site_theme:', localStorage.getItem('site_theme'));
  console.debug('glass_style:', localStorage.getItem('glass_style'));
}

/* ---------------------- äº‹ä»¶ç»‘å®šåŠåˆå§‹åŒ– ---------------------- */
document.getElementById('downloadAllBtn').addEventListener('click', downloadAll);
document.getElementById('refreshBtn').addEventListener('click', ()=> location.reload());
document.getElementById('readmeBtn').addEventListener('click', ()=> {
  document.getElementById('modName').textContent='è¯´æ˜'; document.getElementById('modTitle').textContent='ç«™ç‚¹è¯´æ˜';
  document.getElementById('modContent').textContent = `è¯´æ˜ï¼š
- æˆ‘å·²å¢å¼ºâ€œé€æ˜ç£¨ç ‚â€é£æ ¼ï¼Œæä¾›æµ…è‰² / æ·±è‰² / ç€è‰² ä¸‰ç§ç»ç’ƒæ ·å¼ï¼Œä»¥åŠå¤šç§ä¸»é¢˜è‰²ï¼ˆæ©™/è“/ç»¿/ç´«ï¼‰ã€‚
- ä¸»é¢˜èœå•ä¸ºå•æŒ‰é’®å±•å¼€ï¼Œå·²ä¿®å¤é‡å é—®é¢˜ï¼Œå¹¶æ›´é¡ºæ»‘åœ°æ¸²æŸ“é«˜å…‰ä¸é˜´å½±ã€‚
- ç®¡ç†å‘˜æŒ‰é’®æ”¹è¿›ï¼šè‹¥å½“å‰ç”¨æˆ·ä¸º admin ä¼šç›´æ¥æ‰“å¼€ç®¡ç†é¢æ¿ï¼›å¦åˆ™ä¼šæ‰“å¼€ç™»å½•å¹¶é¢„å¡« admin ç”¨æˆ·åï¼Œä¾¿äºç®¡ç†å‘˜ç™»å½•ã€‚
- ç”¨æˆ·å¯ä»¥åœ¨â€œæˆ‘çš„ç©ºé—´â€åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤è‡ªå·±çš„æ–‡ä»¶ï¼Œä¿å­˜äº localStorageï¼ˆæµè§ˆå™¨çº§æ°¸ä¹…ï¼‰ã€‚è¦å®ç°è·¨è®¾å¤‡æ°¸ä¹…è¯·æ¥å…¥æœåŠ¡å™¨æˆ– GitHub APIã€‚`;
  document.getElementById('modal').style.display='flex';
  document.getElementById('modDownload').onclick = ()=>{}; document.getElementById('modCopy').onclick = ()=> navigator.clipboard.writeText(document.getElementById('modContent').textContent).then(()=> showToast());
});
document.addEventListener('keydown', e=> { if(e.key==='Escape'){ closeAllFloating(); } });

/* ---------------------- å°å·¥å…·ï¼šé¢„å¡« admin ç™»å½•ï¼ˆåœ¨ admin æ— æ³•ä½¿ç”¨æ—¶ï¼‰ ---------------------- */
function prefillAdminIfNeeded(){
  // if no admin user exists, ensureAdmin will create one on init
  // if admin exists but cannot login, adminDiagnostics helps debugging
  const adminUserExists = loadUsers().some(u=>u.username==='admin');
  if(!adminUserExists){
    console.debug('admin user missing â€” ensureAdmin will create default admin on init');
  }
}

/* ---------------------- åˆå§‹åŒ–å¯åŠ¨é¡ºåº ---------------------- */
(async function init(){
  await ensureAdmin();          // ç¡®ä¿æœ‰ admin ç”¨æˆ·
  initFiles();                  // åˆå¹¶å†…ç½® + æŒ‰ owner å­˜å‚¨çš„æ–‡ä»¶
  restoreTheme();               // æ¢å¤ä¸»é¢˜ä¸ç»ç’ƒæ ·å¼
  applyFilters();               // æ¸²æŸ“æ–‡ä»¶
  renderAuthSlot();             // æ¸²æŸ“ç™»å½•/ç”¨æˆ·æ§½ä½
  prefillAdminIfNeeded();
  // compute SHA1 for transparency logs
  FILES.forEach(f=> sha1Hex(f.content || '').then(h=> console.debug(`${f.name} SHA1: ${h}`)).catch(()=>{}));
})();
</script>
</body>
</html>
